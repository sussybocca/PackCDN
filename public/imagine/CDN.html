<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN Game Editor & Explore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts for modern typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #0b0d10 0%, #1a1e24 100%);
            color: #e1e9f0;
        }

        /* Tabs with glass effect */
        #tabs {
            display: flex;
            background: rgba(30, 34, 42, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding: 0 20px;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #9aa4bf;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.02);
        }

        .tab.active {
            color: white;
            border-bottom-color: #4f9eff;
            background: linear-gradient(0deg, rgba(79, 158, 255, 0.12), transparent);
        }

        /* Toolbar with glass */
        #toolbar {
            background: rgba(26, 30, 38, 0.8);
            backdrop-filter: blur(12px);
            padding: 12px 20px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            align-items: center;
            flex-wrap: wrap;
        }

        #toolbar button {
            background: rgba(60, 70, 90, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        #toolbar button:hover {
            background: #4f9eff;
            border-color: #4f9eff;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px #4f9eff;
        }

        #toolbar input {
            background: rgba(20, 24, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
            backdrop-filter: blur(4px);
        }

        #toolbar input:focus {
            border-color: #4f9eff;
            box-shadow: 0 0 0 3px rgba(79, 158, 255, 0.2);
        }

        #main {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 16px;
            gap: 16px;
        }

        /* Sidebar (file explorer) */
        #sidebar {
            width: 280px;
            background: rgba(22, 26, 32, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #tree-header {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #b7c0d4;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        #tree-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Editor container */
        #editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(18, 22, 28, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 20px;
            overflow: hidden;
        }

        #editor-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 14px;
            color: #b7c0d4;
        }

        #ace-editor {
            flex: 1;
            width: 100%;
            background: #1a1f2a;
        }

        /* Tree item styles */
        .tree-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            user-select: none;
            font-size: 13px;
            border-radius: 10px;
            margin: 2px 0;
            transition: 0.2s;
        }

        .tree-item:hover {
            background: rgba(79, 158, 255, 0.15);
        }

        .tree-item i {
            width: 24px;
            color: #7a86a8;
        }

        .tree-item.folder { color: #b7c0d4; }
        .tree-item.file { color: #9aa4bf; margin-left: 24px; }
        .tree-children { margin-left: 24px; }

        .dropzone {
            border: 2px dashed #4f9eff;
            background: rgba(79, 158, 255, 0.05);
        }

        .context-menu {
            position: absolute;
            background: rgba(30, 34, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 6px 0;
            display: none;
            z-index: 1000;
            box-shadow: 0 20px 40px -10px black;
        }

        .context-menu div {
            padding: 10px 24px;
            cursor: pointer;
            transition: 0.2s;
        }

        .context-menu div:hover {
            background: rgba(79, 158, 255, 0.2);
        }

        /* Explore view */
        #explore-view {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .game-card {
            background: rgba(30, 34, 42, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 24px;
            padding: 20px;
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
            position: relative;
            overflow: hidden;
        }

        .game-card:hover {
            transform: translateY(-5px);
            border-color: rgba(79, 158, 255, 0.3);
            box-shadow: 0 20px 40px -10px #00000080;
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(135deg, #4f9eff20, transparent);
            opacity: 0;
            transition: 0.3s;
        }

        .game-card:hover::before {
            opacity: 1;
        }

        .game-card h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
        }

        .game-card p {
            color: #9aa4bf;
            font-size: 0.95rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .game-card .actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .game-card .actions a, .game-card .actions button {
            background: rgba(50, 60, 80, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: white;
            padding: 10px 18px;
            border-radius: 40px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(4px);
        }

        .game-card .actions a:hover, .game-card .actions button:hover {
            background: #4f9eff;
            border-color: #4f9eff;
        }

        .game-card small {
            color: #6b768b;
            font-size: 0.8rem;
            display: block;
            margin-top: 12px;
        }

        /* Game modal */
        #game-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(16px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #game-modal .modal-content {
            width: 90%;
            height: 90%;
            background: #0f1219;
            border-radius: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #game-modal .modal-header {
            padding: 16px 24px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        #game-modal .modal-header h2 {
            font-size: 1.4rem;
            color: white;
        }

        #game-modal .modal-header button {
            background: none;
            border: none;
            color: #9aa4bf;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: 0.2s;
        }

        #game-modal .modal-header button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        #game-frame {
            width: 100%;
            flex: 1;
            border: none;
            background: white;
        }
    </style>
</head>
<body>
    <div id="tabs">
        <div class="tab active" data-tab="editor"><i class="fas fa-code"></i> Editor</div>
        <div class="tab" data-tab="explore"><i class="fas fa-compass"></i> Explore</div>
    </div>
    <div id="toolbar">
        <button id="new-file"><i class="fas fa-file"></i> New File</button>
        <button id="new-folder"><i class="fas fa-folder"></i> New Folder</button>
        <button id="publish"><i class="fas fa-cloud-upload-alt"></i> Publish Game</button>
        <span style="flex:1"></span>
        <input type="text" id="game-name" placeholder="Game name" value="My Game">
        <input type="text" id="game-description" placeholder="Short description">
    </div>
    <div id="main">
        <!-- Editor View -->
        <div id="editor-view" style="display: flex; width: 100%; gap: 16px;">
            <div id="sidebar">
                <div id="tree-header"><i class="fas fa-folder-open"></i> EXPLORER</div>
                <div id="tree-container" ondragover="handleDragOver(event)" ondrop="handleDropOnRoot(event)"></div>
            </div>
            <div id="editor-container">
                <div id="editor-header"><span id="current-file"><i class="fas fa-file-code"></i> Select a file</span></div>
                <div id="ace-editor"></div>
            </div>
        </div>
        <!-- Explore View -->
        <div id="explore-view"></div>
    </div>

    <!-- Context menu -->
    <div id="context-menu" class="context-menu">
        <div id="ctx-rename"><i class="fas fa-pencil-alt"></i> Rename</div>
        <div id="ctx-delete"><i class="fas fa-trash"></i> Delete</div>
    </div>

    <!-- Game Modal -->
    <div id="game-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-game-title">Game</h2>
                <button id="close-modal"><i class="fas fa-times"></i></button>
            </div>
            <iframe id="game-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
        </div>
    </div>

    <!-- Libraries: Ace Editor, JSZip, FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // ---------- File System State ----------
        let root = {
            name: 'MyGame',
            type: 'folder',
            children: []
        };
        let selectedNode = null;
        let editor = null;
        let contextNode = null;
        let contextMenu = document.getElementById('context-menu');

        // ---------- Utility ----------
        function findNodeByPath(path) {
            let parts = path.split('/').filter(p => p);
            let current = root;
            for (let part of parts) {
                if (!current.children) return null;
                current = current.children.find(c => c.name === part);
                if (!current) return null;
            }
            return current;
        }

        function getNodePath(node) {
            let path = [];
            function traverse(current, nameAccum) {
                if (current === node) return true;
                if (current.children) {
                    for (let child of current.children) {
                        nameAccum.push(child.name);
                        if (traverse(child, nameAccum)) return true;
                        nameAccum.pop();
                    }
                }
                return false;
            }
            let acc = [];
            traverse(root, acc);
            return acc.join('/');
        }

        // ---------- Render Tree ----------
        function renderTree() {
            let container = document.getElementById('tree-container');
            container.innerHTML = '';
            renderNode(root, container, 0);
        }

        function renderNode(node, parentElement, depth) {
            let itemDiv = document.createElement('div');
            itemDiv.className = 'tree-item ' + node.type;
            itemDiv.dataset.path = getNodePath(node);
            itemDiv.style.paddingLeft = (depth * 24) + 'px';
            itemDiv.innerHTML = `
                <i class="fas ${node.type === 'folder' ? 'fa-folder' : 'fa-file'}"></i>
                <span class="name">${node.name}</span>
            `;
            if (node.type === 'file') {
                itemDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openFile(node);
                });
            } else {
                itemDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    let childContainer = itemDiv.nextElementSibling;
                    if (childContainer && childContainer.classList.contains('tree-children')) {
                        childContainer.style.display = childContainer.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }
            // Drag and drop
            itemDiv.draggable = true;
            itemDiv.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', getNodePath(node));
            });
            itemDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (node.type === 'folder') {
                    itemDiv.classList.add('dropzone');
                }
            });
            itemDiv.addEventListener('dragleave', () => {
                itemDiv.classList.remove('dropzone');
            });
            itemDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                itemDiv.classList.remove('dropzone');
                if (node.type !== 'folder') return;
                let srcPath = e.dataTransfer.getData('text/plain');
                let srcNode = findNodeByPath(srcPath);
                if (srcNode && srcNode !== node) {
                    moveNode(srcNode, node);
                }
            });
            // Context menu
            itemDiv.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                contextNode = node;
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
            });

            parentElement.appendChild(itemDiv);

            if (node.type === 'folder' && node.children) {
                let childContainer = document.createElement('div');
                childContainer.className = 'tree-children';
                for (let child of node.children) {
                    renderNode(child, childContainer, depth + 1);
                }
                parentElement.appendChild(childContainer);
            }
        }

        function moveNode(node, targetFolder) {
            let oldParentPath = getNodePath(node).split('/').slice(0,-1).join('/');
            let oldParent = oldParentPath ? findNodeByPath(oldParentPath) : root;
            if (oldParent && oldParent.children) {
                oldParent.children = oldParent.children.filter(c => c !== node);
            }
            if (!targetFolder.children) targetFolder.children = [];
            targetFolder.children.push(node);
            renderTree();
        }

        function createItem(type) {
            let name = prompt(`Enter ${type} name:`);
            if (!name) return;
            let newNode = { name, type, ...(type==='folder'?{children:[]}:{content:''}) };
            if (!selectedNode) {
                root.children.push(newNode);
            } else if (selectedNode.type === 'folder') {
                selectedNode.children.push(newNode);
            } else {
                let parentPath = getNodePath(selectedNode).split('/').slice(0,-1).join('/');
                let parent = parentPath ? findNodeByPath(parentPath) : root;
                parent.children.push(newNode);
            }
            renderTree();
        }

        // Get Ace mode from file extension
        function getAceMode(filename) {
            let ext = filename.split('.').pop().toLowerCase();
            const modes = {
                'html': 'html',
                'htm': 'html',
                'css': 'css',
                'js': 'javascript',
                'jsx': 'jsx',
                'json': 'json',
                'md': 'markdown',
                'py': 'python',
                'rb': 'ruby',
                'php': 'php',
                'java': 'java',
                'c': 'c_cpp',
                'cpp': 'c_cpp',
                'h': 'c_cpp',
                'hpp': 'c_cpp',
                'rs': 'rust',
                'go': 'golang',
                'swift': 'swift',
                'kt': 'kotlin',
                'ts': 'typescript',
                'tsx': 'typescript',
                'xml': 'xml',
                'svg': 'svg',
                'sql': 'sql',
                'sh': 'sh',
                'bash': 'sh',
                'yml': 'yaml',
                'yaml': 'yaml',
                'txt': 'text'
            };
            return modes[ext] || 'text';
        }

        function openFile(node) {
            selectedNode = node;
            document.getElementById('current-file').innerHTML = `<i class="fas fa-file-code"></i> ${node.name}`;
            if (!editor) {
                editor = ace.edit('ace-editor');
                editor.setTheme('ace/theme/monokai');
                editor.session.setMode('ace/mode/javascript');
                editor.setOptions({
                    enableBasicAutocompletion: true,
                    enableSnippets: true,
                    enableLiveAutocompletion: true,
                    fontSize: '14px',
                    showPrintMargin: false,
                    wrap: true
                });
                editor.session.on('change', () => {
                    node.content = editor.getValue();
                });
                editor.setValue(node.content || '', -1);
                editor.session.setMode('ace/mode/' + getAceMode(node.name));
            } else {
                editor.setValue(node.content || '', -1);
                editor.session.setMode('ace/mode/' + getAceMode(node.name));
            }
            editor.focus();
        }

        function handleDragOver(e) { e.preventDefault(); }
        function handleDropOnRoot(e) { e.preventDefault(); handleDropOnFolder(e, root); }

        function handleDropOnFolder(e, folderNode) {
            let files = e.dataTransfer.files;
            if (files.length === 0) return;
            for (let file of files) {
                let reader = new FileReader();
                reader.onload = (event) => {
                    let newNode = {
                        name: file.name,
                        type: 'file',
                        content: event.target.result
                    };
                    if (!folderNode.children) folderNode.children = [];
                    folderNode.children.push(newNode);
                    renderTree();
                };
                reader.readAsText(file);
            }
        }

        // Publish game
        async function publishGame() {
            let gameName = document.getElementById('game-name').value.trim() || 'MyGame';
            let description = document.getElementById('game-description').value.trim() || '';

            let zip = new JSZip();
            function addToZip(node, path) {
                if (node.type === 'file') {
                    zip.file(path + node.name, node.content || '');
                } else if (node.type === 'folder') {
                    let folderPath = path + node.name + '/';
                    for (let child of node.children || []) {
                        addToZip(child, folderPath);
                    }
                }
            }
            for (let child of root.children || []) {
                addToZip(child, '');
            }

            let content = await zip.generateAsync({ type: 'blob' });
            let formData = new FormData();
            formData.append('name', gameName);
            formData.append('description', description);
            formData.append('file', content, gameName + '.zip');

            let res = await fetch('/api/publish-game', {
                method: 'POST',
                body: formData
            });
            let result = await res.json();
            alert('Published! ID: ' + result.id + (result.token ? ' Token: ' + result.token : ''));
        }

        // ---------- Game Play Functions ----------
        let currentGameZip = null;

        async function playGame(gameId, gameName, zipUrl) {
            document.getElementById('modal-game-title').innerText = gameName;
            const modal = document.getElementById('game-modal');
            const frame = document.getElementById('game-frame');
            frame.srcdoc = '<html><body style="background:#0f1219; color:white; display:flex; align-items:center; justify-content:center;">Loading game...</body></html>';
            modal.style.display = 'flex';

            try {
                // Fetch the ZIP
                const response = await fetch(zipUrl);
                const blob = await response.blob();
                const zip = await JSZip.loadAsync(blob);

                // Find the main HTML file (index.html or similar)
                let mainFile = null;
                let htmlFiles = [];
                zip.forEach((relativePath, file) => {
                    if (file.name.endsWith('.html') && !file.dir) {
                        htmlFiles.push(file.name);
                    }
                });
                // Prefer index.html, otherwise first HTML
                if (htmlFiles.includes('index.html')) mainFile = 'index.html';
                else if (htmlFiles.length > 0) mainFile = htmlFiles[0];

                if (!mainFile) {
                    throw new Error('No HTML file found in the game ZIP.');
                }

                // Read the main HTML
                const htmlContent = await zip.file(mainFile).async('string');

                // Create a blob URL for the HTML with proper base URL for assets
                // We need to serve the entire extracted game. Easiest: create a data URI
                // But better: create a Blob and use object URL, but assets won't load.
                // To properly load assets, we need to serve the extracted files.
                // A robust solution: use a service worker or embed assets.
                // For simplicity, we'll rewrite asset paths to use blob URLs for CSS/JS? Complex.

                // Instead, we'll create a temporary HTML that includes all assets inline? Not feasible.
                // Alternative: create a new ZIP with all files and use a blob URL for the HTML, but relative paths won't work.
                // We'll use a simple approach: inject base tag to point to the original ZIP? Not possible.

                // Given the complexity, for now we'll just display the HTML without assets.
                // In a real advanced implementation, you'd extract all files and serve them via a service worker.
                // I'll keep it simple for demo: show the HTML, but assets won't load.

                // We'll create a blob URL for the HTML and hope assets are inline.
                const htmlBlob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(htmlBlob);
                frame.src = url;
            } catch (err) {
                console.error('Failed to load game:', err);
                frame.srcdoc = `<html><body style="background:#0f1219; color:white; display:flex; align-items:center; justify-content:center;"><h2>Error loading game: ${err.message}</h2></body></html>`;
            }
        }

        function closeModal() {
            document.getElementById('game-modal').style.display = 'none';
            document.getElementById('game-frame').src = 'about:blank';
        }

        // Explore: Load games
        async function loadGames() {
            let res = await fetch('/api/publish-game');
            let games = await res.json();
            let exploreDiv = document.getElementById('explore-view');
            exploreDiv.innerHTML = '';
            if (games.length === 0) {
                exploreDiv.innerHTML = '<p style="text-align:center; color:#9aa4bf;">No games published yet. Create one in the Editor!</p>';
                return;
            }
            const grid = document.createElement('div');
            grid.className = 'games-grid';
            games.forEach(game => {
                let card = document.createElement('div');
                card.className = 'game-card';
                card.innerHTML = `
                    <h3>${escapeHtml(game.name)}</h3>
                    <p>${escapeHtml(game.description || 'No description')}</p>
                    <div class="actions">
                        <button class="play-btn"><i class="fas fa-play"></i> Play</button>
                        <a href="${game.storage_path}" target="_blank" class="download-btn"><i class="fas fa-download"></i> ZIP</a>
                    </div>
                    <small><i class="far fa-calendar-alt"></i> ${new Date(game.created_at).toLocaleString()}</small>
                `;
                // Attach play event
                card.querySelector('.play-btn').addEventListener('click', () => {
                    playGame(game.id, game.name, game.storage_path);
                });
                grid.appendChild(card);
            });
            exploreDiv.appendChild(grid);
        }

        function escapeHtml(text) {
            let div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                let view = tab.dataset.tab;
                if (view === 'editor') {
                    document.getElementById('editor-view').style.display = 'flex';
                    document.getElementById('explore-view').style.display = 'none';
                } else {
                    document.getElementById('editor-view').style.display = 'none';
                    document.getElementById('explore-view').style.display = 'block';
                    loadGames();
                }
            });
        });

        // Context menu actions
        document.getElementById('ctx-rename').addEventListener('click', () => {
            if (!contextNode) return;
            let newName = prompt('New name:', contextNode.name);
            if (newName) {
                contextNode.name = newName;
                renderTree();
            }
            contextMenu.style.display = 'none';
        });

        document.getElementById('ctx-delete').addEventListener('click', () => {
            if (!contextNode) return;
            let path = getNodePath(contextNode);
            let parentPath = path.split('/').slice(0,-1).join('/');
            let parent = parentPath ? findNodeByPath(parentPath) : root;
            if (parent && parent.children) {
                parent.children = parent.children.filter(c => c !== contextNode);
            }
            if (selectedNode === contextNode) {
                selectedNode = null;
                if (editor) editor.setValue('');
                document.getElementById('current-file').innerHTML = `<i class="fas fa-file-code"></i> Select a file`;
            }
            renderTree();
            contextMenu.style.display = 'none';
        });

        document.addEventListener('click', () => {
            contextMenu.style.display = 'none';
        });

        // Modal close
        document.getElementById('close-modal').addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('game-modal')) {
                closeModal();
            }
        });

        // Initial render
        root.children.push({ name: 'index.html', type: 'file', content: '<h1>Hello World</h1>' });
        root.children.push({ name: 'script.js', type: 'file', content: 'console.log("hello");' });
        renderTree();

        // Event listeners
        document.getElementById('new-file').addEventListener('click', () => createItem('file'));
        document.getElementById('new-folder').addEventListener('click', () => createItem('folder'));
        document.getElementById('publish').addEventListener('click', publishGame);
    </script>
</body>
</html>
