<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSX Editor Â· moduleâ€‘aware</title>
    <style>
        /* (keep your existing styles â€“ unchanged) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            color: #ccc;
        }
        .toolbar {
            background: #2d2d2d;
            padding: 8px 16px;
            display: flex;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid #3c3c3c;
            flex-wrap: wrap;
        }
        .toolbar button {
            background: #0e639c;
            border: none;
            color: white;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid #1a1a1a;
        }
        .toolbar button:hover {
            background: #1177bb;
        }
        .toolbar button.danger {
            background: #a12626;
        }
        .toolbar button.danger:hover {
            background: #c42b2b;
        }
        .toolbar .filename-edit {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            background: #3c3c3c;
            padding: 4px 10px;
            border-radius: 20px;
        }
        .filename-edit label {
            font-size: 12px;
            color: #aaa;
        }
        .filename-edit input {
            background: #252526;
            border: 1px solid #3f3f46;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            width: 200px;
        }
        .filename-edit input:focus {
            outline: 1px solid #0e639c;
        }
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 220px;
            background: #252526;
            border-right: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 12px 12px 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #969696;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-header button {
            background: none;
            border: 1px solid #3c3c3c;
            color: #ccc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
        }
        .sidebar-header button:hover {
            background: #3c3c3c;
        }
        .file-list {
            list-style: none;
            padding: 4px 0;
        }
        .file-item {
            padding: 8px 12px 8px 24px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid transparent;
            user-select: none;
        }
        .file-item.active {
            background: #37373d;
            border-left-color: #0e639c;
            color: white;
        }
        .file-item .name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-item .remove {
            visibility: hidden;
            background: none;
            border: none;
            color: #aaa;
            font-size: 16px;
            cursor: pointer;
            padding: 0 4px;
        }
        .file-item:hover .remove {
            visibility: visible;
        }
        .file-item .remove:hover {
            color: #f48771;
        }
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #editor-container {
            flex: 1;
            min-height: 0;
            background: #1e1e1e;
        }
        #hsx-editor {
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            outline: none;
        }
        .preview-panel {
            height: 240px;
            border-top: 1px solid #3c3c3c;
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
        }
        .preview-header {
            padding: 6px 12px;
            background: #2d2d2d;
            font-size: 12px;
            color: #aaa;
            display: flex;
            justify-content: space-between;
        }
        .preview-header button {
            background: none;
            border: none;
            color: #0e639c;
            cursor: pointer;
            font-size: 12px;
        }
        #preview-frame {
            width: 100%;
            flex: 1;
            background: white;
            border: none;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="btn-new">âž• New file</button>
        <button id="btn-run" style="background: #2b8a3e;">â–¶ Run project</button>
        <button id="btn-delete" class="danger">ðŸ—‘ Delete current</button>
        <div class="filename-edit">
            <label for="filename-input">Filename</label>
            <input type="text" id="filename-input" placeholder="name.hsx" value="main.hsx">
        </div>
    </div>
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>EXPLORER</span>
                <button id="btn-new-side">ðŸ“„</button>
            </div>
            <ul id="file-list" class="file-list"></ul>
        </div>
        <div class="editor-area">
            <div id="editor-container">
                <textarea id="hsx-editor"></textarea>
            </div>
            <div class="preview-panel">
                <div class="preview-header">
                    <span>ðŸ“¦ preview (iframe)</span>
                    <button id="btn-refresh-preview">â†» refresh</button>
                </div>
                <iframe id="preview-frame" title="HSX preview" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // ---------- global error guard ----------
            window.addEventListener('error', function(e) {
                console.error('Caught error:', e.error);
                // Don't let runtime errors kill the UI
                e.preventDefault();
            });

            // ---------- state ----------
            let files = [
                { name: 'main.hsx', content: '// Welcome to HSX ðŸŒ€\nhsx define component Hello\n<h1>Hello from HSX!</h1>\nhsx end\n\nhsx render Hello\n\n:hsx: set debug on\n:hsx: fx attach fx' }
            ];
            let currentIndex = 0;

            // DOM elements
            const fileListEl = document.getElementById('file-list');
            const filenameInput = document.getElementById('filename-input');
            const editor = document.getElementById('hsx-editor');
            const previewFrame = document.getElementById('preview-frame');

            // ---------- helper functions ----------
            function renderFileList() {
                fileListEl.innerHTML = '';
                files.forEach((file, idx) => {
                    const li = document.createElement('li');
                    li.className = 'file-item' + (idx === currentIndex ? ' active' : '');
                    li.dataset.index = idx;

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'name';
                    nameSpan.textContent = file.name;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove';
                    removeBtn.innerHTML = 'âœ•';
                    removeBtn.title = 'delete file';
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteFile(idx);
                    });

                    li.appendChild(nameSpan);
                    li.appendChild(removeBtn);
                    li.addEventListener('click', () => switchToFile(idx));
                    fileListEl.appendChild(li);
                });
            }

            function switchToFile(index) {
                if (index < 0 || index >= files.length) return;
                files[currentIndex].content = editor.value;
                currentIndex = index;
                editor.value = files[currentIndex].content;
                updateFilenameInput();
                renderFileList();
            }

            function updateFilenameInput() {
                filenameInput.value = files[currentIndex].name;
            }

            function getSafeFilename(base) {
                let name = base;
                let counter = 1;
                while (files.some(f => f.name === name)) {
                    const dot = base.lastIndexOf('.');
                    if (dot === -1) name = `${base}${counter}`;
                    else name = `${base.slice(0, dot)}${counter}${base.slice(dot)}`;
                    counter++;
                }
                return name;
            }

            function addFile() {
                const baseName = 'newfile.hsx';
                const newName = getSafeFilename(baseName);
                files.push({ name: newName, content: '// new HSX file' });
                switchToFile(files.length - 1);
            }

            function deleteFile(index) {
                if (files.length === 1) {
                    alert('Cannot delete the only file.');
                    return;
                }
                if (!confirm(`Delete "${files[index].name}"?`)) return;
                files.splice(index, 1);
                if (currentIndex >= index) currentIndex = Math.max(0, currentIndex - 1);
                if (currentIndex >= files.length) currentIndex = files.length - 1;
                editor.value = files[currentIndex].content;
                renderFileList();
                updateFilenameInput();
            }

            filenameInput.addEventListener('change', () => {
                const newName = filenameInput.value.trim();
                if (!newName) return;
                if (newName === files[currentIndex].name) return;
                if (files.some((f, i) => i !== currentIndex && f.name === newName)) {
                    alert('A file with that name already exists.');
                    filenameInput.value = files[currentIndex].name;
                    return;
                }
                files[currentIndex].name = newName;
                renderFileList();
            });

            editor.addEventListener('input', () => {
                files[currentIndex].content = editor.value;
            });

            // ---------- build preview HTML (now using module for runtime) ----------
            function generatePreviewHTML() {
                const filesMap = {};
                files.forEach(f => { filesMap[f.name] = f.content; });
                const filesMapJson = JSON.stringify(filesMap, null, 2);

                return `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>HSX preview</title></head>
<body style="margin:0; padding:8px; font-family:sans-serif">
<script type="module">
// Import the runtime as a module
import HSXRuntime from './hsx-runtime.js';  // adjust path if needed

// Patch the load method to use embedded files
const originalLoad = HSXRuntime.prototype.load;
HSXRuntime.prototype.load = async function(filePath) {
    const HSX_FILES = ${filesMapJson};
    if (HSX_FILES[filePath]) {
        return this.loadFromText(HSX_FILES[filePath]);
    }
    return originalLoad.call(this, filePath);
};

// Run all files
const runtime = new HSXRuntime();
for (const [name, content] of Object.entries(HSX_FILES)) {
    await runtime.loadFromText(content);
}
<\/script>
</body>
</html>`;
            }

            function runPreview() {
                const html = generatePreviewHTML();
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                previewFrame.src = url;
                setTimeout(() => URL.revokeObjectURL(url), 10000);
            }

            // ---------- event listeners (attached regardless of runtime) ----------
            document.getElementById('btn-new').addEventListener('click', addFile);
            document.getElementById('btn-new-side').addEventListener('click', addFile);
            document.getElementById('btn-delete').addEventListener('click', () => {
                deleteFile(currentIndex);
            });
            document.getElementById('btn-run').addEventListener('click', runPreview);
            document.getElementById('btn-refresh-preview').addEventListener('click', () => {
                if (previewFrame.src) previewFrame.src = previewFrame.src;
                else runPreview();
            });

            filenameInput.addEventListener('blur', () => {
                filenameInput.dispatchEvent(new Event('change', { bubbles: true }));
            });

            // ---------- initialize ----------
            renderFileList();
            updateFilenameInput();
            editor.value = files[currentIndex].content;
            setTimeout(runPreview, 300);
        })();
    </script>
</body>
</html>
