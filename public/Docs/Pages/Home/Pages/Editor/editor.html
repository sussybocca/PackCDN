<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Pack Studio Â· BLOCK JUMP (FINAL)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', 'Consolas', monospace;
        }
        #game-canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .hud {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(4px);
            color: white;
            padding: 12px 24px;
            border-radius: 40px;
            border: 2px solid #007acc;
            box-shadow: 0 0 20px #007acc;
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 100;
            pointer-events: none;
        }
        .hud i {
            color: #ffaa00;
            filter: drop-shadow(0 0 8px gold);
        }
        #score {
            font-weight: 700;
            color: #ffd966;
            font-size: 1.5rem;
        }
        .controls {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(0,0,0,0.6);
            color: #ccc;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid #007acc;
            z-index: 100;
            pointer-events: none;
        }
        .creator-panel {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(30,30,40,0.9);
            backdrop-filter: blur(8px);
            border: 2px solid #007acc;
            border-radius: 16px;
            padding: 20px;
            color: white;
            width: 280px;
            box-shadow: 0 0 30px #007acc;
            z-index: 200;
            pointer-events: auto;
        }
        .creator-panel h3 {
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #007acc;
        }
        .creator-panel input, .creator-panel select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.4);
            border: 1px solid #3e3e42;
            color: white;
            border-radius: 8px;
            font-family: monospace;
        }
        .creator-panel button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #007acc, #68217a);
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .creator-panel button:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px #007acc;
        }
        .color-option {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-option.selected {
            border-color: white;
            transform: scale(1.1);
        }
        .color-picker {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }
        /* Code editor modal */
        .code-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30,30,40,0.95);
            border: 2px solid #007acc;
            border-radius: 16px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            color: white;
            z-index: 1000;
            box-shadow: 0 0 40px #007acc;
            display: none;
        }
        .code-modal.active {
            display: block;
        }
        .code-modal h3 {
            margin: 0 0 15px 0;
            color: #007acc;
        }
        .code-modal textarea {
            width: 100%;
            height: 150px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #3e3e42;
            color: #fff;
            padding: 10px;
            font-family: monospace;
            border-radius: 8px;
            resize: vertical;
        }
        .code-modal button {
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #007acc, #68217a);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        .code-modal .close-btn {
            float: right;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        /* Publish modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .modal {
            background: rgba(30,30,40,0.95);
            border: 2px solid #007acc;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            color: white;
            box-shadow: 0 0 40px #007acc;
        }
        .modal h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #007acc;
            margin-top: 0;
        }
        .modal .close-btn {
            float: right;
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
        }
        .modal .close-btn:hover {
            color: #007acc;
        }
        .modal .config-item {
            margin-bottom: 20px;
        }
        .modal .config-label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        .modal .config-input {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.4);
            border: 1px solid #3e3e42;
            color: white;
            border-radius: 8px;
        }
        .modal .config-row {
            display: flex;
            gap: 15px;
        }
        .modal .config-row .config-item {
            flex: 1;
        }
        .modal .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal .checkbox-group input {
            width: 18px;
            height: 18px;
        }
        .modal .advanced-options {
            background: rgba(0,0,0,0.3);
            border-left: 3px solid #68217a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .modal .advanced-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #68217a;
        }
        .modal .advanced-content {
            display: none;
            margin-top: 10px;
        }
        .modal .advanced-options.expanded .advanced-content {
            display: block;
        }
        .modal .publish-results {
            background: rgba(0,0,0,0.4);
            border-left: 4px solid #107c10;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .modal .security-warning {
            background: rgba(242,200,17,0.2);
            border-left: 4px solid #f2c811;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .modal .edit-token-display {
            background: rgba(0,0,0,0.5);
            border: 2px dashed #f2c811;
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: monospace;
        }
        .modal .copy-token-btn {
            background: #f2c811;
            color: black;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .loading {
            text-align: center;
            padding: 30px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0,122,204,0.2);
            border-top: 4px solid #007acc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <canvas id="game-canvas"></canvas>

    <!-- HUD -->
    <div class="hud">
        <i class="fas fa-cube"></i>
        <span>PACK STUDIO Â· BLOCK JUMP</span>
        <i class="fas fa-star"></i>
        <span id="score">0</span>
    </div>
    <div class="controls">
        <i class="fas fa-keyboard"></i> WASD move | SPACE jump | [E] edit block | [C] create block
    </div>

    <!-- Block Creator Panel -->
    <div class="creator-panel">
        <h3><i class="fas fa-cube"></i> Create Block</h3>
        <input type="text" id="block-snippet" placeholder="JavaScript snippet" value="ðŸš€ new block">
        <div class="color-picker" id="color-picker">
            <div class="color-option selected" style="background:#ff5555" data-color="#ff5555"></div>
            <div class="color-option" style="background:#55ff55" data-color="#55ff55"></div>
            <div class="color-option" style="background:#5555ff" data-color="#5555ff"></div>
            <div class="color-option" style="background:#ffff55" data-color="#ffff55"></div>
            <div class="color-option" style="background:#ff55ff" data-color="#ff55ff"></div>
            <div class="color-option" style="background:#55ffff" data-color="#55ffff"></div>
        </div>
        <button id="create-block-btn"><i class="fas fa-plus"></i> Spawn Block</button>
        <button id="publish-btn"><i class="fas fa-rocket"></i> Publish Pack</button>
    </div>

    <!-- Code Editor Modal (for editing block snippet) -->
    <div id="code-editor-modal" class="code-modal">
        <button class="close-btn" id="code-editor-close">&times;</button>
        <h3><i class="fas fa-code"></i> Edit Block Code</h3>
        <textarea id="block-code-textarea" placeholder="Enter JavaScript code..."></textarea>
        <button id="save-block-code">Save</button>
        <button id="cancel-block-code">Cancel</button>
    </div>

    <!-- Publish Modal -->
    <div class="modal-overlay" id="publish-modal">
        <div class="modal">
            <button class="close-btn" id="modal-close">&times;</button>
            <h2><i class="fas fa-rocket"></i> Publish Your Block Pack</h2>
            <div id="validation-summary"></div>

            <div class="config-item">
                <label class="config-label">Package Name</label>
                <input type="text" class="config-input" id="package-name" value="my-block-pack">
            </div>

            <div class="config-row">
                <div class="config-item">
                    <label class="config-label">Version</label>
                    <input type="text" class="config-input" id="package-version" value="1.0.0">
                </div>
                <div class="config-item checkbox-group">
                    <input type="checkbox" id="is-public" checked> <label for="is-public">Public</label>
                </div>
            </div>

            <div class="advanced-options" id="advanced-options">
                <div class="advanced-header" id="advanced-toggle">
                    <i class="fas fa-chevron-right"></i> <span>Advanced Options</span>
                </div>
                <div class="advanced-content">
                    <div class="config-item checkbox-group">
                        <input type="checkbox" id="is-new-version"> <label for="is-new-version">Create New Version</label>
                    </div>
                    <div id="new-version-fields" style="display: none;">
                        <div class="config-item">
                            <label class="config-label">Base Pack ID</label>
                            <input type="text" class="config-input" id="base-pack-id">
                        </div>
                        <div class="config-item">
                            <label class="config-label">Edit Token</label>
                            <input type="text" class="config-input" id="edit-token">
                        </div>
                    </div>
                    <div class="config-item">
                        <label class="config-label">User ID (Optional)</label>
                        <input type="text" class="config-input" id="user-id">
                    </div>
                    <div class="config-item checkbox-group">
                        <input type="checkbox" id="compile-wasm"> <label for="compile-wasm">Compile to WASM</label>
                    </div>
                    <div class="config-item">
                        <label class="config-label">Collaborators</label>
                        <input type="text" class="config-input" id="collaborators" placeholder="user1,user2">
                    </div>
                </div>
            </div>

            <div class="loading" id="publish-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Publishing...</p>
            </div>

            <div class="security-warning" id="security-warning" style="display: none;">
                <div style="display: flex; gap:10px; align-items:center;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Anonymous Publishing</strong>
                </div>
                <p>Save this edit token to manage your pack later:</p>
                <div class="edit-token-display">
                    <span id="edit-token-display"></span>
                    <button class="copy-token-btn" id="copy-token-btn"><i class="fas fa-copy"></i> Copy</button>
                </div>
            </div>

            <div class="publish-results" id="publish-results" style="display: none;"></div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="confirm-publish" style="flex:1; background: linear-gradient(135deg,#007acc,#68217a); border:none; color:white; padding:12px; border-radius:8px; font-weight:bold;">Publish Now</button>
                <button id="cancel-publish" style="flex:1; background:#2d2d30; border:none; color:white; padding:12px; border-radius:8px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Three.js import map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>

    <!-- Game & Publish Script -->
    <script type="module">
        import * as THREE from 'three';

        // --- Setup scene, camera, renderer ---
        const canvas = document.getElementById('game-canvas');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0e15); // deep space

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 5, 15);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        dirLight.shadow.camera.near = 2;
        dirLight.shadow.camera.far = 20;
        dirLight.shadow.camera.left = -10;
        dirLight.shadow.camera.right = 10;
        dirLight.shadow.camera.top = 10;
        dirLight.shadow.camera.bottom = -10;
        scene.add(dirLight);

        const fillLight = new THREE.PointLight(0x4466ff, 0.5, 20);
        fillLight.position.set(0, 5, 5);
        scene.add(fillLight);

        // --- Ground with reflective appearance ---
        const groundGeo = new THREE.CircleGeometry(40, 32);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x1a1a2e, roughness: 0.3, metalness: 0.3, emissive: 0x050510 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);

        // Decorative grid
        const gridHelper = new THREE.GridHelper(40, 20, 0x3399ff, 0x224466);
        gridHelper.position.y = 0.01;
        scene.add(gridHelper);

        // --- Advanced Player Model (stylized robot) ---
        const playerGroup = new THREE.Group();

        // Body (torso) with armor plates
        const bodyGeo = new THREE.CylinderGeometry(0.7, 0.7, 1.4, 8);
        const bodyMat = new THREE.MeshStandardMaterial({ color: 0x44aaff, emissive: 0x113355, roughness: 0.3, metalness: 0.7 });
        const body = new THREE.Mesh(bodyGeo, bodyMat);
        body.castShadow = true;
        body.receiveShadow = true;
        body.position.y = 0.7;
        playerGroup.add(body);

        // Shoulder pads
        const padGeo = new THREE.SphereGeometry(0.4, 8);
        const padMat = new THREE.MeshStandardMaterial({ color: 0xaa44aa, emissive: 0x220022 });
        const leftPad = new THREE.Mesh(padGeo, padMat);
        leftPad.position.set(-0.8, 1.1, 0);
        leftPad.scale.set(0.6, 0.3, 0.4);
        leftPad.castShadow = true;
        playerGroup.add(leftPad);
        const rightPad = new THREE.Mesh(padGeo, padMat);
        rightPad.position.set(0.8, 1.1, 0);
        rightPad.scale.set(0.6, 0.3, 0.4);
        rightPad.castShadow = true;
        playerGroup.add(rightPad);

        // Head with visor
        const headGeo = new THREE.SphereGeometry(0.5, 16, 16);
        const headMat = new THREE.MeshStandardMaterial({ color: 0xffaa33, emissive: 0x331100 });
        const head = new THREE.Mesh(headGeo, headMat);
        head.castShadow = true;
        head.receiveShadow = true;
        head.position.y = 1.7;
        playerGroup.add(head);

        // Visor (glowing)
        const visorGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 8);
        const visorMat = new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x004444 });
        const visor = new THREE.Mesh(visorGeo, visorMat);
        visor.rotation.x = Math.PI / 2;
        visor.rotation.z = Math.PI / 2;
        visor.position.set(0, 1.7, 0.4);
        visor.castShadow = true;
        playerGroup.add(visor);

        // Arms
        const armGeo = new THREE.CylinderGeometry(0.2, 0.2, 1.2, 6);
        const armMat = new THREE.MeshStandardMaterial({ color: 0x44aaff, emissive: 0x113355 });
        
        const leftArm = new THREE.Mesh(armGeo, armMat);
        leftArm.castShadow = true;
        leftArm.receiveShadow = true;
        leftArm.position.set(-1.0, 1.2, 0);
        leftArm.rotation.z = 0.3;
        leftArm.rotation.x = 0.2;
        playerGroup.add(leftArm);

        const rightArm = new THREE.Mesh(armGeo, armMat);
        rightArm.castShadow = true;
        rightArm.receiveShadow = true;
        rightArm.position.set(1.0, 1.2, 0);
        rightArm.rotation.z = -0.3;
        rightArm.rotation.x = -0.2;
        playerGroup.add(rightArm);

        // Legs
        const legGeo = new THREE.CylinderGeometry(0.25, 0.25, 1.2, 6);
        const legMat = new THREE.MeshStandardMaterial({ color: 0x44aaff, emissive: 0x113355 });
        
        const leftLeg = new THREE.Mesh(legGeo, legMat);
        leftLeg.castShadow = true;
        leftLeg.receiveShadow = true;
        leftLeg.position.set(-0.4, 0.0, 0);
        playerGroup.add(leftLeg);

        const rightLeg = new THREE.Mesh(legGeo, legMat);
        rightLeg.castShadow = true;
        rightLeg.receiveShadow = true;
        rightLeg.position.set(0.4, 0.0, 0);
        playerGroup.add(rightLeg);

        // Jetpack
        const jetGeo = new THREE.BoxGeometry(0.6, 1.0, 0.4);
        const jetMat = new THREE.MeshStandardMaterial({ color: 0xaa44aa, emissive: 0x220022 });
        const jet = new THREE.Mesh(jetGeo, jetMat);
        jet.castShadow = true;
        jet.receiveShadow = true;
        jet.position.set(0, 1.0, -0.7);
        playerGroup.add(jet);

        // Thrusters (small spheres)
        const thrusterGeo = new THREE.SphereGeometry(0.2, 6);
        const thrusterMat = new THREE.MeshStandardMaterial({ color: 0xff6600, emissive: 0x441100 });
        const leftThrust = new THREE.Mesh(thrusterGeo, thrusterMat);
        leftThrust.position.set(-0.2, 0.5, -0.9);
        playerGroup.add(leftThrust);
        const rightThrust = new THREE.Mesh(thrusterGeo, thrusterMat);
        rightThrust.position.set(0.2, 0.5, -0.9);
        playerGroup.add(rightThrust);

        scene.add(playerGroup);
        playerGroup.position.set(0, 1.2, 0); // adjusted for leg length
        playerGroup.castShadow = true;
        playerGroup.receiveShadow = true;

        // Player light
        const playerLight = new THREE.PointLight(0x44aaff, 1, 12);
        playerGroup.add(playerLight);

        // --- Blocks (with glowing edges) ---
        const blocks = []; // each: { group, snippet, color }

        const snippets = [
            "function hello()", "import wasm", "console.log", "3D =>", "pack.publish", 
            "<div>", "{}", "=>", "WASM!", "git push", "npm install", "three.js"
        ];

        function createBlock(snippet, color, pos) {
            const group = new THREE.Group();
            
            // Main cube
            const geometry = new THREE.BoxGeometry(1.2, 0.6, 1.2);
            const material = new THREE.MeshStandardMaterial({ color, emissive: 0x222222 });
            const cube = new THREE.Mesh(geometry, material);
            cube.castShadow = true;
            cube.receiveShadow = true;
            cube.position.y = 0.3;
            group.add(cube);

            // Glowing edges (wireframe)
            const edges = new THREE.EdgesGeometry(geometry);
            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff }));
            line.position.y = 0.3;
            group.add(line);

            // Text label (canvas sprite)
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 14px "Segoe UI", monospace';
            ctx.textAlign = 'center';
            ctx.fillText(snippet, 64, 30);
            const texture = new THREE.CanvasTexture(canvas);
            const labelMat = new THREE.SpriteMaterial({ map: texture, depthTest: false, depthWrite: false });
            const label = new THREE.Sprite(labelMat);
            label.scale.set(1.2, 0.6, 1);
            label.position.y = 0.9;
            group.add(label);

            group.position.copy(pos);
            scene.add(group);
            blocks.push({ group, snippet, color });
            return group;
        }

        // Initial blocks
        for (let i = 0; i < 12; i++) {
            const angle = (i / 12) * Math.PI * 2;
            const radius = 6 + Math.random() * 4;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            const y = 1 + Math.random() * 2.5;
            const snippet = snippets[i % snippets.length];
            const hue = (i * 30) % 360;
            const color = new THREE.Color(`hsl(${hue}, 80%, 60%)`).getStyle();
            createBlock(snippet, color, new THREE.Vector3(x, y, z));
        }

        // --- Collectibles (stars) with animation ---
        const collectibles = [];
        function createCollectible(pos, color) {
            const geom = new THREE.OctahedronGeometry(0.4);
            const mat = new THREE.MeshStandardMaterial({ color, emissive: 0x442200 });
            const mesh = new THREE.Mesh(geom, mat);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.position.copy(pos);
            scene.add(mesh);
            collectibles.push(mesh);
            return mesh;
        }

        for (let i = 0; i < 20; i++) {
            const angle = Math.random() * Math.PI * 2;
            const radius = 4 + Math.random() * 8;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            const y = 1.8 + Math.random() * 4;
            const color = new THREE.Color(`hsl(${Math.random()*360}, 100%, 60%)`);
            createCollectible(new THREE.Vector3(x, y, z), color);
        }

        // --- Physics state ---
        const velocity = new THREE.Vector3(0, 0, 0);
        const gravity = -0.018;
        const moveSpeed = 0.12;
        const jumpPower = 0.32;
        let onGround = false;

        const keyState = { w: false, a: false, s: false, d: false, space: false, e: false };

        window.addEventListener('keydown', (e) => {
            switch(e.code) {
                case 'KeyW': keyState.w = true; e.preventDefault(); break;
                case 'KeyA': keyState.a = true; e.preventDefault(); break;
                case 'KeyS': keyState.s = true; e.preventDefault(); break;
                case 'KeyD': keyState.d = true; e.preventDefault(); break;
                case 'Space': keyState.space = true; e.preventDefault(); break;
                case 'KeyE': keyState.e = true; e.preventDefault(); break;
                case 'KeyC': createBlockAtCamera(); e.preventDefault(); break;
                default: break;
            }
        });
        window.addEventListener('keyup', (e) => {
            switch(e.code) {
                case 'KeyW': keyState.w = false; e.preventDefault(); break;
                case 'KeyA': keyState.a = false; e.preventDefault(); break;
                case 'KeyS': keyState.s = false; e.preventDefault(); break;
                case 'KeyD': keyState.d = false; e.preventDefault(); break;
                case 'Space': keyState.space = false; e.preventDefault(); break;
                case 'KeyE': keyState.e = false; e.preventDefault(); break;
                default: break;
            }
        });

        // --- Block editing system ---
        let currentEditingBlock = null;
        const codeModal = document.getElementById('code-editor-modal');
        const codeTextarea = document.getElementById('block-code-textarea');
        const saveCodeBtn = document.getElementById('save-block-code');
        const cancelCodeBtn = document.getElementById('cancel-block-code');
        const closeCodeBtn = document.getElementById('code-editor-close');

        function openEditor(block) {
            currentEditingBlock = block;
            codeTextarea.value = block.snippet;
            codeModal.classList.add('active');
        }

        function closeEditor() {
            codeModal.classList.remove('active');
            currentEditingBlock = null;
        }

        saveCodeBtn.addEventListener('click', () => {
            if (currentEditingBlock) {
                const newSnippet = codeTextarea.value;
                currentEditingBlock.snippet = newSnippet;
                // Update label texture
                const group = currentEditingBlock.group;
                // Remove old label and create new one
                const oldLabel = group.children.find(child => child.isSprite);
                if (oldLabel) group.remove(oldLabel);
                
                const canvas = document.createElement('canvas');
                canvas.width = 128;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 14px "Segoe UI", monospace';
                ctx.textAlign = 'center';
                ctx.fillText(newSnippet, 64, 30);
                const texture = new THREE.CanvasTexture(canvas);
                const labelMat = new THREE.SpriteMaterial({ map: texture, depthTest: false, depthWrite: false });
                const label = new THREE.Sprite(labelMat);
                label.scale.set(1.2, 0.6, 1);
                label.position.y = 0.9;
                group.add(label);
            }
            closeEditor();
        });

        cancelCodeBtn.addEventListener('click', closeEditor);
        closeCodeBtn.addEventListener('click', closeEditor);

        // Check for nearby block to edit (E key)
        function checkEdit() {
            if (!keyState.e) return;
            const editRange = 2.5;
            for (let block of blocks) {
                const dist = playerGroup.position.distanceTo(block.group.position);
                if (dist < editRange) {
                    openEditor(block);
                    break;
                }
            }
        }

        // --- Block creation from UI and C key ---
        let selectedColor = '#ff5555';
        document.querySelectorAll('.color-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                selectedColor = opt.dataset.color;
            });
        });

        document.getElementById('create-block-btn').addEventListener('click', () => {
            const snippet = document.getElementById('block-snippet').value || 'code';
            createBlockAtCamera(snippet, selectedColor);
        });

        function createBlockAtCamera(snippet = 'new block', color = selectedColor) {
            const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            dir.y = 0;
            dir.normalize();
            const pos = playerGroup.position.clone().add(dir.multiplyScalar(3));
            pos.y = Math.max(1, playerGroup.position.y);
            createBlock(snippet, color, pos);
        }

        // --- Scoring ---
        let score = 0;
        const scoreElement = document.getElementById('score');

        // --- Collision and physics (robust AABB) ---
        function checkCollisions() {
            // Ground collision
            if (playerGroup.position.y < 0.6) {
                playerGroup.position.y = 0.6;
                velocity.y = 0;
                onGround = true;
            } else {
                onGround = false;
            }

            const playerBox = new THREE.Box3().setFromObject(playerGroup);
            for (let block of blocks) {
                const blockBox = new THREE.Box3().setFromObject(block.group);
                if (playerBox.intersectsBox(blockBox)) {
                    // Compute overlap
                    const playerMin = playerBox.min;
                    const playerMax = playerBox.max;
                    const blockMin = blockBox.min;
                    const blockMax = blockBox.max;

                    const overlapX = Math.min(playerMax.x, blockMax.x) - Math.max(playerMin.x, blockMin.x);
                    const overlapY = Math.min(playerMax.y, blockMax.y) - Math.max(playerMin.y, blockMin.y);
                    const overlapZ = Math.min(playerMax.z, blockMax.z) - Math.max(playerMin.z, blockMin.z);

                    // Resolve smallest overlap axis
                    if (overlapX < overlapY && overlapX < overlapZ) {
                        // X axis
                        if (playerMin.x < blockMin.x) {
                            playerGroup.position.x = blockMin.x - 0.6; // player half-width
                        } else {
                            playerGroup.position.x = blockMax.x + 0.6;
                        }
                        velocity.x = 0;
                    } else if (overlapY < overlapX && overlapY < overlapZ) {
                        // Y axis
                        if (playerMin.y < blockMin.y) {
                            playerGroup.position.y = blockMin.y - 0.6; // player half-height
                            velocity.y = 0;
                            onGround = true;
                        } else {
                            playerGroup.position.y = blockMax.y + 0.6;
                            velocity.y = 0;
                        }
                    } else {
                        // Z axis
                        if (playerMin.z < blockMin.z) {
                            playerGroup.position.z = blockMin.z - 0.6;
                        } else {
                            playerGroup.position.z = blockMax.z + 0.6;
                        }
                        velocity.z = 0;
                    }
                }
            }

            // Collectibles
            for (let i = collectibles.length - 1; i >= 0; i--) {
                const item = collectibles[i];
                const dist = playerGroup.position.distanceTo(item.position);
                if (dist < 1.2) {
                    scene.remove(item);
                    collectibles.splice(i, 1);
                    score += 10;
                    scoreElement.textContent = score;
                    
                    const angle = Math.random() * Math.PI * 2;
                    const radius = 5 + Math.random() * 8;
                    const x = Math.cos(angle) * radius;
                    const z = Math.sin(angle) * radius;
                    const y = 2 + Math.random() * 4;
                    const color = new THREE.Color(`hsl(${Math.random()*360}, 100%, 60%)`);
                    createCollectible(new THREE.Vector3(x, y, z), color);
                }
            }
        }

        // --- Camera follow (third person) ---
        function updateCamera() {
            const targetOffset = new THREE.Vector3(-5, 3, 5);
            const desiredPos = playerGroup.position.clone().add(targetOffset);
            camera.position.lerp(desiredPos, 0.05);
            camera.lookAt(playerGroup.position.clone().add(new THREE.Vector3(0, 1.2, 0)));
        }

        // --- Animation loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Movement
            const moveX = (keyState.d ? 1 : 0) - (keyState.a ? 1 : 0);
            const moveZ = (keyState.s ? 1 : 0) - (keyState.w ? 1 : 0);
            if (moveX !== 0 || moveZ !== 0) {
                const angle = Math.atan2(moveX, moveZ);
                velocity.x += Math.sin(angle) * moveSpeed;
                velocity.z += Math.cos(angle) * moveSpeed;
            }

            // Jump
            if (keyState.space && onGround) {
                velocity.y = jumpPower;
                onGround = false;
            }

            // Gravity
            velocity.y += gravity;

            // Update position
            playerGroup.position.x += velocity.x;
            playerGroup.position.y += velocity.y;
            playerGroup.position.z += velocity.z;

            // Damping
            velocity.x *= 0.9;
            velocity.z *= 0.9;
            if (!onGround) {
                velocity.x *= 0.98;
                velocity.z *= 0.98;
            }

            // Bounds
            playerGroup.position.x = Math.max(-18, Math.min(18, playerGroup.position.x));
            playerGroup.position.z = Math.max(-18, Math.min(18, playerGroup.position.z));

            // Collisions
            checkCollisions();

            // Rotate player to face movement direction
            if (velocity.length() > 0.1) {
                playerGroup.rotation.y = Math.atan2(velocity.x, velocity.z);
            }

            // Check for edit key
            checkEdit();

            // Animate collectibles (spin)
            collectibles.forEach(c => c.rotation.y += 0.02);

            updateCamera();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- PUBLISH FUNCTIONALITY (original /api/publish.mjs) ---
        const publishModal = document.getElementById('publish-modal');
        const modalClose = document.getElementById('modal-close');
        const cancelPublish = document.getElementById('cancel-publish');
        const confirmPublish = document.getElementById('confirm-publish');
        const publishBtn = document.getElementById('publish-btn');
        const validationSummary = document.getElementById('validation-summary');
        const publishLoading = document.getElementById('publish-loading');
        const publishResults = document.getElementById('publish-results');
        const securityWarning = document.getElementById('security-warning');
        const editTokenDisplay = document.getElementById('edit-token-display');
        const copyTokenBtn = document.getElementById('copy-token-btn');

        const packageNameInput = document.getElementById('package-name');
        const packageVersionInput = document.getElementById('package-version');
        const isPublicCheckbox = document.getElementById('is-public');
        const isNewVersionCheckbox = document.getElementById('is-new-version');
        const newVersionFields = document.getElementById('new-version-fields');
        const basePackIdInput = document.getElementById('base-pack-id');
        const editTokenInput = document.getElementById('edit-token');
        const userIdInput = document.getElementById('user-id');
        const compileWasmCheckbox = document.getElementById('compile-wasm');
        const advancedToggle = document.getElementById('advanced-toggle');
        const advancedOptions = document.getElementById('advanced-options');
        const collaboratorsInput = document.getElementById('collaborators');

        // Advanced toggle
        advancedToggle.addEventListener('click', () => {
            advancedOptions.classList.toggle('expanded');
            const icon = advancedToggle.querySelector('i');
            icon.classList.toggle('fa-chevron-right');
            icon.classList.toggle('fa-chevron-down');
        });

        isNewVersionCheckbox.addEventListener('change', (e) => {
            newVersionFields.style.display = e.target.checked ? 'block' : 'none';
        });

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }

        function validatePackage() {
            const errors = [];
            if (!packageNameInput.value.trim()) errors.push('Package name required');
            if (!packageVersionInput.value.trim()) errors.push('Version required');
            return { errors, warnings: [], info: [] };
        }

        async function publishPackage() {
            const validation = validatePackage();
            if (validation.errors.length > 0) {
                showError(validation.errors[0]);
                return;
            }

            const isNewVersion = isNewVersionCheckbox.checked;
            const basePackId = basePackIdInput.value.trim();
            if (isNewVersion && !basePackId) {
                showError('Base Pack ID required for version update');
                return;
            }

            publishLoading.style.display = 'block';
            publishResults.style.display = 'none';
            securityWarning.style.display = 'none';
            validationSummary.innerHTML = '';

            try {
                // Build files object
                const files = {};

                // package.json
                const packageJson = {
                    name: packageNameInput.value,
                    version: packageVersionInput.value,
                    description: 'A pack of code blocks from Block Jump',
                    type: 'module',
                    main: 'index.js',
                    pack: {
                        type: 'basic',
                        sandbox: { level: 'strict' }
                    }
                };
                files['package.json'] = JSON.stringify(packageJson, null, 2);

                // Each block as a .js file
                blocks.forEach((block, index) => {
                    const filename = `block_${index+1}.js`;
                    files[filename] = block.snippet;
                });

                // index.js that exports all blocks
                files['index.js'] = '// Entry point generated from blocks\n' + 
                    blocks.map((b, i) => `export { default as block${i+1} } from './block_${i+1}.js';`).join('\n');

                const collaborators = collaboratorsInput.value
                    ? collaboratorsInput.value.split(',').map(s => s.trim()).filter(s => s)
                    : [];

                const requestBody = {
                    name: packageNameInput.value,
                    packJson: JSON.stringify(packageJson),
                    files: files,
                    isPublic: isPublicCheckbox.checked,
                    packageType: 'basic',
                    version: packageVersionInput.value,
                    isNewVersion: isNewVersion,
                    basePackId: isNewVersion ? basePackId : null,
                    userId: userIdInput.value.trim() || null,
                    editToken: editTokenInput.value.trim() || null,
                    collaborators: collaborators,
                    compileToWasm: compileWasmCheckbox.checked,
                    wasmConfig: { initialMemory: 1, maxMemory: 65536 }
                };

                const response = await fetch('/api/publish.mjs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.details || 'Unknown API error');
                }

                publishLoading.style.display = 'none';
                publishResults.style.display = 'block';
                publishResults.innerHTML = `
                    <div class="result-item"><strong>Package ID:</strong> ${result.packId}</div>
                    <div class="result-item"><strong>CDN:</strong> <a href="${result.cdnUrl}" target="_blank">${result.cdnUrl}</a></div>
                    <div class="result-item"><strong>Install:</strong> <code>${result.installCommand}</code></div>
                `;

                if (!userIdInput.value.trim() && result.editToken) {
                    securityWarning.style.display = 'block';
                    editTokenDisplay.textContent = result.editToken;
                    copyTokenBtn.onclick = () => {
                        navigator.clipboard.writeText(result.editToken).then(() => {
                            copyTokenBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                            setTimeout(() => { copyTokenBtn.innerHTML = '<i class="fas fa-copy"></i> Copy'; }, 2000);
                        });
                    };
                }

                showSuccess('Package published!');
            } catch (error) {
                publishLoading.style.display = 'none';
                showError('Publish failed: ' + error.message);
                console.error(error);
            }
        }

        publishBtn.addEventListener('click', () => {
            const validation = validatePackage();
            validationSummary.innerHTML = '';
            if (validation.errors.length > 0) {
                validationSummary.innerHTML = `<div style="color:#d13438;">${validation.errors.join('<br>')}</div>`;
            } else {
                validationSummary.innerHTML = `<div style="color:#4ec9b0;">âœ“ Validation passed</div>`;
            }
            publishModal.classList.add('active');
            publishResults.style.display = 'none';
            publishLoading.style.display = 'none';
            securityWarning.style.display = 'none';
        });

        modalClose.addEventListener('click', () => publishModal.classList.remove('active'));
        cancelPublish.addEventListener('click', () => publishModal.classList.remove('active'));
        confirmPublish.addEventListener('click', publishPackage);

        publishModal.addEventListener('click', (e) => {
            if (e.target === publishModal) publishModal.classList.remove('active');
        });
    </script>
</body>
</html>
