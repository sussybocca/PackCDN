name: Update Cards JSON

on:
  push:
    paths:
      - 'public/imagine/**'
      - 'app/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-cards:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate cards.json
        id: generate
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // ---- Configuration ----
            const IMAGINE_DIR = 'public/imagine';
            const APP_DIR = 'app';
            const OUTPUT_PATH = 'public/cards.json';

            // Helper: extract title from HTML file
            function getHtmlTitle(filePath) {
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                const match = content.match(/<title>(.*?)<\/title>/i);
                return match ? match[1].trim() : null;
              } catch { return null; }
            }

            // Helper: extract description from HTML meta tag
            function getHtmlDescription(filePath) {
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                const match = content.match(/<meta\s+name="description"\s+content="([^"]*)"/i);
                return match ? match[1] : null;
              } catch { return null; }
            }

            // Helper: extract category from HTML meta tag
            function getHtmlCategory(filePath) {
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                const match = content.match(/<meta\s+name="category"\s+content="([^"]*)"/i);
                return match ? match[1] : 'demos';
              } catch { return 'demos'; }
            }

            // Helper: extract title from a Next.js page component
            function getNextTitle(filePath) {
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                // Look for exported metadata.title
                const metaMatch = content.match(/export\s+const\s+metadata\s*=\s*\{\s*title:\s*['"]([^'"]+)['"]/);
                if (metaMatch) return metaMatch[1];
                // Fallback: component name
                const compMatch = content.match(/export\s+default\s+function\s+(\w+)|const\s+(\w+)\s*=\s*\(?/);
                if (compMatch) return compMatch[1] || compMatch[2];
                // Use folder name
                return path.basename(path.dirname(filePath)).replace(/[-_]/g, ' ');
              } catch { return null; }
            }

            function getNextDescription(filePath) {
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                const match = content.match(/export\s+const\s+metadata\s*=\s*\{\s*description:\s*['"]([^'"]+)['"]/);
                return match ? match[1] : 'Next.js page';
              } catch { return 'Next.js page'; }
            }

            function getNextCategory(filePath) {
              // You could also parse metadata.category; default to 'nextjs'
              return 'nextjs';
            }

            // Collect HTML files from imagine/
            const htmlCards = [];
            if (fs.existsSync(IMAGINE_DIR)) {
              const walk = (dir) => {
                const files = fs.readdirSync(dir);
                for (const file of files) {
                  const fullPath = path.join(dir, file);
                  const stat = fs.statSync(fullPath);
                  if (stat.isDirectory()) {
                    walk(fullPath);
                  } else if (file.endsWith('.html') || file.endsWith('.htm')) {
                    const relativePath = path.relative(IMAGINE_DIR, fullPath);
                    const link = `imagine/${relativePath.replace(/\\/g, '/')}`;
                    const title = getHtmlTitle(fullPath) || path.basename(file, path.extname(file)).replace(/[-_]/g, ' ');
                    const description = getHtmlDescription(fullPath) || 'Explore this immersive experience.';
                    const category = getHtmlCategory(fullPath);
                    htmlCards.push({
                      icon: 'üìÑ',
                      title,
                      description,
                      features: ['Immersive experience', 'Interactive content'],
                      link,
                      category,
                      highlight: false
                    });
                  }
                }
              };
              walk(IMAGINE_DIR);
            }

            // Collect Next.js pages from app/
            const nextCards = [];
            if (fs.existsSync(APP_DIR)) {
              const walk = (dir) => {
                const files = fs.readdirSync(dir);
                for (const file of files) {
                  const fullPath = path.join(dir, file);
                  const stat = fs.statSync(fullPath);
                  if (stat.isDirectory()) {
                    walk(fullPath);
                  } else if (file === 'page.jsx' || file === 'page.tsx' || file === 'page.js') {
                    const relativeDir = path.relative(APP_DIR, path.dirname(fullPath));
                    let route = '/' + relativeDir.replace(/\\/g, '/');
                    if (route === '/.') route = '/'; // root page (app/page.jsx) ‚Äì we skip it because it's the main page
                    if (route === '/') continue; // skip root, it's the main page

                    const title = getNextTitle(fullPath) || path.basename(path.dirname(fullPath)).replace(/[-_]/g, ' ');
                    const description = getNextDescription(fullPath);
                    const category = getNextCategory(fullPath);
                    nextCards.push({
                      icon: '‚öõÔ∏è',
                      title,
                      description,
                      features: ['Next.js page', 'Server‚Äërendered React'],
                      link: route,
                      category,
                      highlight: true
                    });
                  }
                }
              };
              walk(APP_DIR);
            }

            // Combine and write
            const allCards = [...htmlCards, ...nextCards];
            fs.writeFileSync(OUTPUT_PATH, JSON.stringify(allCards, null, 2));
            console.log(`‚úÖ Generated cards.json with ${allCards.length} entries.`);

      - name: Commit and push cards.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/cards.json
          if ! git diff --staged --quiet; then
            git commit -m "Auto‚Äëupdate cards.json [skip ci]"
            git push
          else
            echo "No changes to cards.json."
          fi
