name: Autoâ€‘link Imagine Files

on:
  push:
    paths:
      - 'public/imagine/**'          # triggers for any change inside imagine/
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-selector:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install HTML parser (without touching package files)
        run: npm install --no-save --no-package-lock node-html-parser

      - name: Update selector.html with new imagine files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { parse } = require('node-html-parser');

            const selectorPath = 'public/selector.html';
            const imagineDir = 'public/imagine';

            // 1. Read the main selector page
            const selectorHtml = fs.readFileSync(selectorPath, 'utf8');
            const root = parse(selectorHtml);

            // 2. Locate the container where cards live
            const grid = root.querySelector('.selector-grid');
            if (!grid) {
              core.setFailed('Could not find .selector-grid in selector.html');
              return;
            }

            // 3. Recursively get all HTML files inside imagine/ (including subfolders)
            function getAllHtmlFiles(dir, baseDir = dir) {
              let results = [];
              const list = fs.readdirSync(dir);
              for (const item of list) {
                const fullPath = path.join(dir, item);
                const stat = fs.statSync(fullPath);
                if (stat.isDirectory()) {
                  results = results.concat(getAllHtmlFiles(fullPath, baseDir));
                } else if (item.endsWith('.html')) {
                  // Store the file path and its relative path from imagineDir
                  const relativePath = path.relative(baseDir, fullPath);
                  results.push({ fullPath, relativePath });
                }
              }
              return results;
            }

            if (!fs.existsSync(imagineDir)) {
              console.log('âš ï¸  imagine/ folder not found â€“ nothing to do.');
              return;
            }

            const files = getAllHtmlFiles(imagineDir);
            if (files.length === 0) {
              console.log('No HTML files found in imagine/ â€“ nothing to do.');
              return;
            }

            // Sort files by relative path for consistent order
            files.sort((a, b) => a.relativePath.localeCompare(b.relativePath));

            // Helper: extract <title> from an HTML file
            function extractTitle(filePath) {
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                const doc = parse(content);
                const titleTag = doc.querySelector('title');
                return titleTag ? titleTag.text.trim() : null;
              } catch {
                return null;
              }
            }

            // Helper: extract meta description or first <p> as a short description
            function extractDescription(filePath) {
              try {
                const content = fs.readFileSync(filePath, 'utf8');
                const doc = parse(content);
                const metaDesc = doc.querySelector('meta[name="description"]');
                if (metaDesc) {
                  return metaDesc.getAttribute('content') || '';
                }
                const firstP = doc.querySelector('p');
                if (firstP) {
                  return firstP.text.trim().substring(0, 150) + 'â€¦';
                }
              } catch {}
              return 'Explore this immersive experience.';
            }

            // 4. Loop through each HTML file
            for (const { fullPath, relativePath } of files) {
              // The link from selector.html to the file (both inside public/)
              const link = `imagine/${relativePath.replace(/\\/g, '/')}`;

              // Skip if a button with this link already exists
              const existing = root.querySelector(`.select-btn[onclick*="${link}"]`);
              if (existing) {
                console.log(`Link for ${relativePath} already present â€“ skipping.`);
                continue;
              }

              // Extract or generate a title
              let title = extractTitle(fullPath);
              if (!title) {
                title = path.basename(relativePath, '.html').replace(/[-_]/g, ' ');
                title = title.charAt(0).toUpperCase() + title.slice(1);
              }

              // Get a short description
              const description = extractDescription(fullPath);

              // Create a new card that matches your existing design
              const cardHtml = `
                <div class="experience-card floating" style="animation-delay: ${files.indexOf({fullPath,relativePath}) * 0.2}s;">
                  <div class="card-icon">ðŸ“„</div>
                  <h2 class="card-title">${title}</h2>
                  <p class="card-description">${description}</p>
                  <ul class="card-features">
                    <li>Immersive experience</li>
                    <li>New dimension</li>
                    <li>Interactive content</li>
                  </ul>
                  <button class="select-btn" onclick="window.location.href='${link}'">
                    explore
                  </button>
                </div>
              `;

              // Append the new card to the grid
              grid.appendChild(parse(cardHtml));
              console.log(`âœ… Added card for ${relativePath}`);
            }

            // 5. Write the updated HTML back to disk
            fs.writeFileSync(selectorPath, root.toString());
            console.log('selector.html updated successfully.');

      - name: Commit and push changes (only if selector.html changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/selector.html
          if ! git diff --staged --quiet; then
            git commit -m "Autoâ€‘add imagine file links [skip ci]"
            git push
          else
            echo "No changes to selector.html; skipping commit."
          fi
